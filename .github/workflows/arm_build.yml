on: [push, pull_request]

jobs:
  aarch64_job:
    # The host should always be Linux
    runs-on: ubuntu-20.04
    name: Build on bullseye aarch64
    steps:
      - uses: actions/checkout@v2.1.0
      - uses: uraimo/run-on-arch-action@v2.1.1
        name: Run commands
        id: runcmd
        with:
          arch: aarch64
          distro: bullseye

          # Not required, but speeds up builds by storing container images in
          # a GitHub package registry.
          githubToken: ${{ github.token }}

          # Set an output parameter `uname` for use in subsequent steps
          run: |
            set -ex
            uname -a
            apt-get update
            apt-get install -y git \
            cmake \
            build-essential \
            libgtk-3-dev \
            libwebkit2gtk-4.0 \
            libwebkit2gtk-4.0-dev \
            libcurl4-openssl-dev \
            alsa-tools \
            libasound2-dev \
            libjack-dev \
            libfreetype6-dev \
            libxinerama-dev \
            libxcb-xinerama0 \
            libxinerama1 \
            x11proto-xinerama-dev \
            libxrandr-dev \
            libgl1-mesa-dev \
            libxcursor-dev \
            libxcursor1 \
            libxcb-cursor-dev \
            libxcb-cursor0
            # apt-get install -y --fix-missing
            apt list --installed
            find /usr/include -name "asoundlib.h" -print
            git submodule update --depth 1 --init --recursive
            export SVER=`cat VERSION`
            export GH=`git log -1 --format=%h`
            echo "Version ${SVER} hash ${GH}"
            # make it available below
            echo "##vso[task.setvariable variable=STOCHAS_VERSION]${SVER}"
            echo "##vso[task.setvariable variable=GH;isOutput=true]${GH}"
            cmake -Bbuild -DSTOCHAS_VERSION=${STOCHAS_VERSION}
            cmake --build build --config Release
            LINARCH=`uname -m`
            NM=stochas-${STOCHAS_VERSION}.${GH}-linux-${LINARCH}.tgz
            mkdir -p build/product/
            mkdir -p build/Stochas/Standalone
            cp -r build/stochas_artefacts/VST3/* build/Stochas
            cp -r build/stochas_artefacts/Standalone/* build/Stochas/Standalone      
            tar czf "build/product/${NM}" -C build Stochas
